generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("APPDB_URL")
}

model cards {
  card_id String @id @db.Char(2)
  suit    String @db.Char(1)
  power   Int    @db.SmallInt
  points  Int    @db.SmallInt

  hands  hands[]
  plays  plays[]
  blinds blinds[]
}

model friend_requests {
  from_user_id     Int
  to_user_id       Int
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  users_friend_requests_from_user_idTousers users @relation("friend_requests_from_user_idTousers", fields: [from_user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  users_friend_requests_to_user_idTousers   users @relation("friend_requests_to_user_idTousers", fields: [to_user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([from_user_id, to_user_id])
}

model friends {
  user_1_id        Int
  user_2_id        Int
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  users_friends_user_1_idTousers users @relation("friends_user_1_idTousers", fields: [user_1_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  users_friends_user_2_idTousers users @relation("friends_user_2_idTousers", fields: [user_2_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_1_id, user_2_id])
}

model houses {
  house_id             Int         @id @default(autoincrement())
  host_id              Int
  gamemode             gamemodes
  player_count         Int         @db.SmallInt // CHANGE?
  leaster_legal        Boolean?
  double               Boolean? // CHANGE
  chat_enabled         Boolean     @default(true)
  players_permitted    user_groups @default(EVERYONE)
  spectators_permitted user_groups @default(EVERYONE)
  datetime_created     DateTime    @default(now()) @db.Timestamp(6)

  users users   @relation(fields: [host_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)
  hands hands[]
}

model hands {
  hand_id          Int      @id @default(autoincrement())
  house_id         Int
  leaster          Boolean?
  called_ace       String?  @db.Char(2)
  opposition_win   Boolean
  winning_score    Int      @db.SmallInt
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  houses  houses    @relation(fields: [house_id], references: [house_id], onDelete: NoAction, onUpdate: NoAction)
  cards   cards?    @relation(fields: [called_ace], references: [card_id], onDelete: NoAction, onUpdate: NoAction)
  players players[]
  tricks  tricks[]
  blinds  blinds[]
}

model players {
  user_id      Int
  hand_id      Int
  player_index Int        @db.SmallInt
  role         hand_roles
  passed       Boolean?

  hands hands @relation(fields: [hand_id], references: [hand_id], onDelete: NoAction, onUpdate: NoAction)
  users users @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([user_id, hand_id])
}

model tricks {
  hand_id     Int
  trick_index Int @db.SmallInt
  winner      Int
  points_won  Int @db.SmallInt

  hands hands   @relation(fields: [hand_id], references: [hand_id], onDelete: NoAction, onUpdate: NoAction)
  users users   @relation(fields: [winner], references: [user_id], onDelete: NoAction, onUpdate: NoAction)
  plays plays[]

  @@id([hand_id, trick_index])
}

model plays {
  hand_id     Int
  trick_index Int    @db.SmallInt
  play_index  Int    @db.SmallInt
  user_id     Int    @db.SmallInt
  card_id     String @db.Char(2)

  cards  cards  @relation(fields: [card_id], references: [card_id], onDelete: NoAction, onUpdate: NoAction)
  tricks tricks @relation(fields: [hand_id, trick_index], references: [hand_id, trick_index], onDelete: NoAction, onUpdate: NoAction)
  users  users  @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([hand_id, trick_index, play_index])
}

model blinds {
  hand_id Int
  card_id String @db.Char(2)

  hands hands @relation(fields: [hand_id], references: [hand_id], onDelete: NoAction, onUpdate: NoAction)
  cards cards @relation(fields: [card_id], references: [card_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([hand_id, card_id])
}

model user_configs {
  user_id                 Int          @id
  lifetime_score_visible  Boolean      @default(true)
  friend_requests_enabled Boolean      @default(true)
  gathering_chat_enabled  Boolean      @default(true)
  safe_chat_enabled       Boolean      @default(false)
  app_theme               color_themes @default(SYSTEM)
  left_fielder            Boolean      @default(true)
  right_fielder           Boolean      @default(false)

  users users @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
}

model users {
  user_id          Int      @id @default(autoincrement())
  username         String   @unique @db.VarChar(32)
  email            String   @unique @db.VarChar(128)
  display_name     String?  @db.VarChar(32)
  pronouns         String?  @db.VarChar(32)
  display_city     String?  @db.VarChar(32)
  display_region   String?  @db.VarChar(32)
  display_country  String?  @db.VarChar(32)
  bio              String?  @db.VarChar(256)
  hands_played     Int?     @default(0)
  lifetime_score   Int?     @default(0)
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  friend_requests_friend_requests_from_user_idTousers friend_requests[] @relation("friend_requests_from_user_idTousers")
  friend_requests_friend_requests_to_user_idTousers   friend_requests[] @relation("friend_requests_to_user_idTousers")
  friends_friends_user_1_idTousers                    friends[]         @relation("friends_user_1_idTousers")
  friends_friends_user_2_idTousers                    friends[]         @relation("friends_user_2_idTousers")
  players                                             players[]
  houses                                              houses[]
  tricks                                              tricks[]
  plays                                               plays[]
  user_configs                                        user_configs?
  users_banned                                        users_banned?
}

model users_banned {
  user_banned_id   Int      @id @default(autoincrement())
  user_id          Int      @unique
  email            String   @unique @db.VarChar(128)
  reason           String?  @db.VarChar(256)
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  users users @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)
}

enum color_themes {
  LIGHT
  DARK
  SYSTEM
}

enum user_groups {
  INVITEES_ONLY
  MY_FRIENDS
  EVERYONE
}

enum hand_roles {
  PICKER
  PARTNER
  OPPOSITION
}

enum gamemodes {
  G_2H_4P // 2 handed, 4 pairs down each, 8 each hand
  G_2H_6P // 2 handed, 6 pairs down each, 4 each hand
  G_3H_10E // 3 handed, 10 each, 2 blind, picker alone
  G_4H_8E_BQP // 4 handed, 8 each, black queens partners, double on the bump
  G_4H_8E_QJP // 4 handed, 8 each, queens jack partners
  G_4H_8E_FQP // 4 handed, 8 each, first 2 queens partners, double on the bump
  G_4H_7E_2B_CA // 4 handed, 7 each, 2 blind, called ace, black 7s removed, double on the bump
  G_4H_7E_4B_PA // 4 handed, 7 each, 4 blind, picker alone
  G_5H_CA // 5 handed, 6 each, 2 blind, called ace
  G_5H_JD // 5 handed, 6 each, 2 blind, jack of diamonds partner
  G_6H_5E_DS // 6 handed, G_5H_CA, dealer sits
  G_6H_5E_JC // 6 handed, 5 each, 4 blind jack of clubs partner
  G_7H_4E_JD // 7 handed, 4 each, 4 blind, jack of diamonds partner
  G_7H_4E_2P // 7 handed, 4 each, 4 blind, jack of diamonds and random partner
  G_7H_4E_LP // 7 handed, 4 each, 4 blind, left of picker is partner
  G_7H_DS // 7 handed, G_5H_CA, dealer and left of dealer sit
  G_8H_4E_BQP // 8 handed, 4 each, black queens partners
  G_8H_4E_FQP // 8 handed, 4 each, first two cleans partners, 7 of diamonds highest trump
}
