generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("APPDB_URL")
}

model Cards {
  card_id   Int    @id @db.SmallInt
  card_code String @unique @db.Char(2)
  suit      String @db.Char(1)
  power     Int    @db.SmallInt
  points    Int    @db.SmallInt

  Hands Hands[]
  Plays Plays[]
}

model Friend_Requests {
  from_user_id     Int
  to_user_id       Int
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  Users_Friend_Requests_from_user_idToUsers Users @relation("Friend_Requests_from_user_idToUsers", fields: [from_user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  Users_Friend_Requests_to_user_idToUsers   Users @relation("Friend_Requests_to_user_idToUsers", fields: [to_user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  // CHECK from_user_id != to_user_id

  @@id([from_user_id, to_user_id])
}

model Friends {
  user_1_id        Int
  user_2_id        Int
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  Users_Friends_user_1_idToUsers Users @relation("Friends_user_1_idToUsers", fields: [user_1_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  Users_Friends_user_2_idToUsers Users @relation("Friends_user_2_idToUsers", fields: [user_2_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  // CHECK user_1_id < user_2_id

  @@id([user_1_id, user_2_id])
}

model Gamemodes {
  gamemode_id   Int    @id @default(autoincrement()) @db.SmallInt
  gamemode_code String @unique @db.VarChar(8)
  player_count  Int    @db.SmallInt
  blind_size    Int?   @db.SmallInt

  Houses Houses[]
}

model Houses {
  house_id             Int         @id @default(autoincrement())
  gamemode_id          Int
  leaster_legal        Boolean?
  automatic_double     Boolean?
  chat_enabled         Boolean     @default(true)
  players_permitted    user_groups @default(EVERYONE)
  spectators_permitted user_groups @default(EVERYONE)
  datetime_created     DateTime    @default(now()) @db.Timestamp(6)

  Gamemodes Gamemodes @relation(fields: [gamemode_id], references: [gamemode_id], onDelete: NoAction, onUpdate: NoAction)
  Hands     Hands[]
}

model Hands {
  hand_id          Int      @id @default(autoincrement())
  house_id         Int
  leaster          Boolean?
  called_ace       String?  @db.Char(2)
  opposition_win   Boolean
  winning_score    Int      @db.SmallInt
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  Houses  Houses    @relation(fields: [house_id], references: [house_id], onDelete: NoAction, onUpdate: NoAction)
  Cards   Cards?    @relation(fields: [called_ace], references: [card_code], onDelete: NoAction, onUpdate: NoAction)
  Players Players[]
  Tricks  Tricks[]
}

model Players {
  user_id      Int
  hand_id      Int
  player_index Int        @db.SmallInt
  role         hand_roles

  Hands Hands @relation(fields: [hand_id], references: [hand_id], onDelete: NoAction, onUpdate: NoAction)
  Users Users @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([user_id, hand_id])
}

model Tricks {
  hand_id     Int
  trick_index Int @db.SmallInt
  winner      Int
  points_won  Int @db.SmallInt

  Hands Hands   @relation(fields: [hand_id], references: [hand_id], onDelete: NoAction, onUpdate: NoAction)
  Users Users   @relation(fields: [winner], references: [user_id], onDelete: NoAction, onUpdate: NoAction)
  Plays Plays[]

  @@id([hand_id, trick_index])
}

model Plays {
  hand_id     Int
  trick_index Int    @db.SmallInt
  play_index  Int    @db.SmallInt
  user_id     Int    @db.SmallInt
  card_code   String @db.Char(2)

  Cards  Cards  @relation(fields: [card_code], references: [card_code], onDelete: NoAction, onUpdate: NoAction)
  Tricks Tricks @relation(fields: [hand_id, trick_index], references: [hand_id, trick_index], onDelete: NoAction, onUpdate: NoAction)
  Users  Users  @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([hand_id, trick_index, play_index])
}

model User_Configs {
  user_id                 Int          @id
  lifetime_score_visible  Boolean      @default(true)
  friend_requests_enabled Boolean      @default(true)
  gathering_chat_enabled  Boolean      @default(true)
  safe_chat_enabled       Boolean      @default(false)
  app_theme               color_themes @default(SYSTEM)
  left_fielder            Boolean      @default(true)
  right_fielder           Boolean      @default(false)

  Users Users @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
}

model Users {
  user_id          Int      @id @default(autoincrement())
  username         String   @unique @db.VarChar(32)
  email            String   @unique @db.VarChar(128)
  display_name     String?  @db.VarChar(32)
  display_city     String?  @db.VarChar(32)
  display_region   String?  @db.VarChar(32)
  display_country  String?  @db.VarChar(32)
  bio              String?  @db.VarChar(256)
  hands_played     Int?     @default(0)
  lifetime_score   Int?     @default(0)
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  Friend_Requests_Friend_Requests_from_user_idToUsers Friend_Requests[] @relation("Friend_Requests_from_user_idToUsers")
  Friend_Requests_Friend_Requests_to_user_idToUsers   Friend_Requests[] @relation("Friend_Requests_to_user_idToUsers")
  Friends_Friends_user_1_idToUsers                    Friends[]         @relation("Friends_user_1_idToUsers")
  Friends_Friends_user_2_idToUsers                    Friends[]         @relation("Friends_user_2_idToUsers")
  Players                                             Players[]
  Tricks                                              Tricks[]
  Plays                                               Plays[]
  User_Configs                                        User_Configs?
  Users_Banned                                        Users_Banned?
}

model Users_Banned {
  user_banned_id   Int      @id @default(autoincrement())
  user_id          Int      @unique
  email            String   @unique @db.VarChar(128)
  reason           String?  @db.VarChar(256)
  datetime_created DateTime @default(now()) @db.Timestamp(6)

  Users Users @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)
}

enum color_themes {
  LIGHT
  DARK
  SYSTEM
}

enum user_groups {
  INVITEES_ONLY
  MY_FRIENDS
  EVERYONE
}

enum hand_roles {
  PICKER
  PARTNER
  OPPOSITION
}
